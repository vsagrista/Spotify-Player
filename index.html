<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="styles.css">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
	<div class="widget">
		<form>
			<h1>Search for a song</h1>
			<label>Name:</label>
			<input name="name">
			<button type="submit" id="search-song-button" class="btn btn-primary">Search!</button>
		</form>
		<div class="header">
		<div class="btn-play disabled"></div>

		<div class="metadata">
		  <p class="title">Hunger of The Pine</p>
		  <p class="author">alt-J</p>

		  <div class="seekbar">
		    <progress value="0" max="30"></progress>
		  </div>
		</div>
		</div>

		<div class="cover">
		<img id="album-img" src="https://i.scdn.co/image/04da6dfc1f5f45fdeba938a0cc71cf372524fd43">
		</div>

		<audio id="audio-song" src="https://p.scdn.co/mp3-preview/8e9c5ffdc38e91659bfe8b6bd44650dfc25a3d31"></audio>
	</div>
	<table class="table table-striped">
		<tr>
			<td>Band Name</td>
			<td>Album Name</td>
			<td>Song</td>
			<td>Cover Image</td>
		</tr>
	</table>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">

var Player = function(){
	this.playing = false;
}

var Song = function(song){
	this.song = song;
}

Song.prototype.fetchSong = function (){
	$.ajax({url: "https://api.spotify.com/v1/search?type=track&query="+this.song+"",
  	success: 
  	this.getSongsArtistsAndCoverImages.bind(this)
	});
}

Song.prototype.getSongsArtistsAndCoverImages = function (songs_object){
	localStorage.setItem('songs_object', JSON.stringify(songs_object));
	window.songListLocalStored = localStorage.getItem('songs_object');
	songListLocalStored = JSON.parse(songListLocalStored)
	this.render(songs_object);
	this.upDatePlayerWithSearchedSong(songs_object,0);
}

Song.prototype.render = function (songs_object){	
	songs_object = songs_object.tracks.items; 
	$('.table-striped tr:gt(0)').remove();
	for (var i=0; i<songs_object.length; i++){
		$(".table-striped").append($(
			"<tr> "+"<td><p>"+songs_object[i].artists[0].name+"</p></td>"+
			"<td><p>"+songs_object[i].album.name+"</p></td>"+
			"<td><p>"+songs_object[i].name+"</p></td>"+
			"<td>"+"<a id='"+i+"' class='band-pic' href='javascript:;'><img src='"+songs_object[i].album.images[1].url+"'>"+"</a></td>"+"</tr>"));
	}
}

Song.prototype.upDatePlayerWithSearchedSong = function (songs_object, index){
	$(".title").text(songs_object.tracks.items[index].name);
	$(".author").text(songs_object.tracks.items[index].artists[0].name);
	$("#album-img").attr("src",songs_object.tracks.items[index].album.images[1].url);
	$("#audio-song").attr("src",songs_object.tracks.items[index].preview_url);	
}

Player.prototype.playOrPauseSong = function (){
	if (this.playing == true){
		$("#audio-song").trigger("pause");
		this.playing = false
	} else {
        $("#audio-song").trigger("play");
        this.playing = true;
      }
}

Player.prototype.showProgressBar = function() {
	var current = $('#audio-song').prop('currentTime');
  	$("progress").attr("value", current);
}

$(document).on("click", "#search-song-button", function (event){
	event.preventDefault();
	newSongSearch = new Song($("input[name=name]").val());
	newSongSearch.fetchSong();
})

var play_music = new Player()
	$(document).on("click", ".btn-play", function(event){
	event.preventDefault();
	play_music.playOrPauseSong()
})

$(document).on("click", ".band-pic", function(event){
	event.preventDefault()
	var bandID = parseInt($(this).attr('id'))
	newSongSearch.upDatePlayerWithSearchedSong(songListLocalStored, bandID)
})

$("#audio-song").on("timeupdate",function(){
	play_music.showProgressBar()
})

</script>
</body>
</html>